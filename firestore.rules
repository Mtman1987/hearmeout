rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isOwner(roomId) {
      let roomData = get(/databases/$(database)/documents/rooms/$(roomId)).data;
      return request.auth != null && request.auth.uid == roomData.ownerId;
    }

    function isDj(roomId) {
      let roomData = get(/databases/$(database)/documents/rooms/$(roomId)).data;
      return request.auth != null && roomData.djId != null && request.auth.uid == roomData.djId;
    }

    function canReadRoom(roomId) {
      let room = get(/databases/$(database)/documents/rooms/$(roomId)).data;
      return room.isPrivate == false || isOwner(roomId);
    }
    
    match /rooms/{roomId} {
      allow list: if request.auth != null;
      allow read: if canReadRoom(roomId);
      allow create: if request.auth != null;
      allow delete: if isOwner(roomId);

      allow update: if 
        // The owner of the room can update any field.
        isOwner(roomId) ||
        // The current DJ can update only the music-related fields.
        (isDj(roomId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['playlist', 'currentTrackId', 'isPlaying', 'currentTrackProgress'])) ||
        // Any user can become the DJ if the spot is currently open.
        (resource.data.djId == null && request.resource.data.djId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['djId', 'djDisplayName'])) ||
        // The current DJ can relinquish their spot.
        (isDj(roomId) && request.resource.data.djId == null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['djId', 'djDisplayName']));

      // Subcollection rules
      match /users/{userId} {
        allow read: if canReadRoom(roomId);
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      match /messages/{messageId} {
        allow read: if canReadRoom(roomId);
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
      }
    }

    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}

    